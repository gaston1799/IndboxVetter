<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settings</title>
  <script src="/theme.js"></script>
  <script src="/config.js"></script>
  <script src="/version.js" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* lightweight dark theme without Tailwind config */
    html[data-theme="dark"] body { background-color: #0f172a; color: #e2e8f0; }
    html[data-theme="dark"] header { background-color: #0b1220; border-color: #1f2937; }
    html[data-theme="dark"] section { background-color: #0b1220; border-color: #1f2937; color: #e2e8f0; }
    html[data-theme="dark"] input, html[data-theme="dark"] select, html[data-theme="dark"] textarea {
      background-color: #0b1220; color: #e2e8f0; border-color: #334155;
    }
    html[data-theme="dark"] .text-slate-500 { color: #94a3b8; }
    html[data-theme="dark"] .hover\:bg-slate-100:hover { background-color: #111827; }
    html[data-theme="dark"] .bg-white { background-color: #0b1220; }
    html[data-theme="dark"] a { color: #93c5fd; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="w-full bg-white border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-xl bg-indigo-600"></div>
        <div>
          <h1 class="text-xl font-semibold">Settings</h1>
          <p class="text-xs text-slate-500" id="userEmail">—</p>
        </div>
      </div>
      <a href="/dashboard.html" class="text-sm px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">Back to dashboard</a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6 space-y-6">
    <section id="subscription" class="bg-white border border-slate-200 rounded-xl p-6 space-y-4">
      <div class="flex flex-col gap-1">
        <h2 class="text-lg font-semibold">Subscription</h2>
        <p class="text-sm text-slate-500" id="subscriptionSummary">Loading…</p>
      </div>
      <form id="planForm" class="space-y-4">
        <fieldset class="grid gap-3 md:grid-cols-2">
          <label class="border border-slate-200 rounded-xl p-4 cursor-pointer hover:border-indigo-400 transition" data-plan-card>
            <div class="flex items-center justify-between gap-2">
              <span class="font-semibold">Basic</span>
              <input type="radio" name="plan" value="basic" class="h-4 w-4 text-indigo-600 border-slate-300">
            </div>
            <p class="text-sm text-slate-500 mt-2">Adds tags and routes emails to the right folder (scam, important, spam, or both).</p>
            <p class="mt-3 text-sm font-medium">Base tier</p>
          </label>
          <label class="border border-slate-200 rounded-xl p-4 cursor-pointer hover:border-indigo-400 transition" data-plan-card>
            <div class="flex items-center justify-between gap-2">
              <span class="font-semibold">Pro</span>
              <input type="radio" name="plan" value="pro" class="h-4 w-4 text-indigo-600 border-slate-300">
            </div>
            <p class="text-sm text-slate-500 mt-2">In progress: automatically deletes spam and scams to free up space.</p>
            <p class="mt-3 text-sm font-medium">Premium tier</p>
          </label>
        </fieldset>
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div class="text-sm text-slate-500">New here? Use <a href="/checkout.html">Checkout</a> or <a href="/devtest.html">DevTest</a> to start a subscription.</div>
          <div class="flex gap-2 md:justify-end">
            <button type="button" id="manageBillingBtn" class="inline-flex items-center px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100 text-sm">Manage billing</button>
            <button type="button" id="cancelPlanBtn" class="inline-flex items-center px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 text-sm">Cancel plan</button>
            <button type="submit" class="inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500 text-sm">Update plan</button>
            <span id="planStatusMessage" class="text-sm text-slate-500 self-center"></span>
          </div>
        </div>
      </form>
    </section>

    <section id="prefsSection" class="bg-white border border-slate-200 rounded-xl p-6 space-y-5" style="display:none">
      <div>
        <h2 class="text-lg font-semibold">Preferences</h2>
        <p class="text-sm text-slate-500">These settings are stored server-side so you can pick up where you left off from any device.</p>
      </div>
      <form id="preferencesForm" class="space-y-5">
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" id="darkToggle" class="h-4 w-4">
          <span class="text-sm font-medium text-slate-700">Dark theme</span>
        </label>
        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <span class="text-sm font-medium text-slate-600">OpenAI API key</span>
            <input type="password" name="openaiKey" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" placeholder="sk-...">
            <span class="block mt-1 text-xs text-slate-500">Used for outbound vetting. Stored encrypted in the local JSON store.</span>
          </label>
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Omitted senders (comma separated)</span>
            <input type="text" name="omittedSenders" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" placeholder="streamelements.com, noreply@paypal.com">
          </label>
        </div>

        <label class="block">
          <span class="text-sm font-medium text-slate-600">What's important to you?</span>
          <textarea name="importantDesc" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" rows="4" placeholder="Sponsors, payments, security, school admin"></textarea>
        </label>

        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Gmail search query</span>
            <input type="text" name="gmailQuery" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" placeholder="label:inbox">
            <span class="block mt-1 text-xs text-slate-500">Use Gmail search syntax to target messages (e.g., label:inbox newer_than:7d).</span>
          </label>
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Max messages per run</span>
            <input type="number" name="gmailMaxResults" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" min="1" max="500" step="1">
            <span class="block mt-1 text-xs text-slate-500">Caps how many new emails InboxVetter fetches each pass (default 200).</span>
          </label>
        </div>
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" name="safeMode" class="h-4 w-4 text-indigo-600 border-slate-300">
          <span class="text-sm font-medium text-slate-600">Safe mode (label and review spam instead of deleting)</span>
        </label>
        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Allow attachments</span>
            <input type="checkbox" name="allowAttachments" class="mt-2 h-4 w-4 text-indigo-600 border-slate-300">
          </label>
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Max attachment size (MB)</span>
            <input type="number" name="maxAttachmentMB" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" min="1" step="1">
          </label>
        </div>

        <div class="grid gap-4 md:grid-cols-3">
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Max images per message</span>
            <input type="number" name="maxImages" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" min="0" step="1">
          </label>
          <label class="block md:col-span-2">
            <span class="text-sm font-medium text-slate-600">Max PDF text characters</span>
            <input type="number" name="maxPdfTextChars" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" min="500" step="100">
          </label>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Default model</span>
            <select name="modelSelect" id="modelSelect" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2">
              <option value="">Use app default</option>
              <option value="gpt-4.1-mini">gpt-4.1-mini (recommended)</option>
              <option value="gpt-4.1">gpt-4.1</option>
              <option value="gpt-5">gpt-5 (reasoning)</option>
              <option value="o3-mini">o3-mini (reasoning, budget)</option>
              <option value="o3">o3</option>
              <option value="gpt-4o-mini">gpt-4o-mini (vision)</option>
              <option value="gpt-4o">gpt-4o</option>
              <option value="__custom">Custom…</option>
            </select>
          </label>
          <label class="block" id="customModelWrap" style="display:none">
            <span class="text-sm font-medium text-slate-600">Custom model ID</span>
            <input type="text" name="customModel" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" placeholder="text-your-model">
          </label>
        </div>

        <div class="flex items-center justify-between gap-3">
          <button type="submit" class="inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500 text-sm">Save preferences</button>
          <span id="preferencesStatus" class="text-sm text-slate-500"></span>
        </div>
      </form>
    </section>
  </main>

  <script>
    const planForm = document.getElementById('planForm');
    const planCards = Array.from(document.querySelectorAll('[data-plan-card]'));
    const planStatusMessage = document.getElementById('planStatusMessage');
    const subscriptionSummary = document.getElementById('subscriptionSummary');
    const prefsSection = document.getElementById('prefsSection');
    const preferencesForm = document.getElementById('preferencesForm');
    const preferencesStatus = document.getElementById('preferencesStatus');
    const modelSelect = document.getElementById('modelSelect');
    const customModelWrap = document.getElementById('customModelWrap');
    const darkToggle = document.getElementById('darkToggle');

    const titleCase = (s) => s.replace(/\b([a-z])/g, m => m.toUpperCase());
    const planName = (slug) => slug ? titleCase(slug.replace(/[._-]+/g, ' ')) : 'Free';
    const normalizePlan = (slug) => {
      const raw = (slug || '').toLowerCase();
      if (!raw) return 'free';
      if (raw === 'creator' || raw === 'base' || raw === 'basic_tier') return 'basic';
      if (raw === 'team' || raw === 'premium' || raw === 'pro_tier') return 'pro';
      return raw;
    };
    const displayPlan = (slug) => {
      const normalized = normalizePlan(slug);
      if (normalized === 'basic') return 'Basic';
      if (normalized === 'pro') return 'Pro';
      if (normalized === 'free') return 'Free';
      return planName(slug || normalized);
    };
    const fmtDate = (iso) => {
      if (!iso) return '—';
      try { return new Date(iso).toLocaleString(); } catch { return iso; }
    };

    function selectPlan(plan) {
      const normalized = normalizePlan(plan);
      planCards.forEach((card) => {
        const input = card.querySelector('input[type="radio"]');
        const active = input.value === normalized;
        input.checked = active;
        card.classList.toggle('border-indigo-500', active);
        card.classList.toggle('shadow-sm', active);
      });
    }

    modelSelect.addEventListener('change', () => {
      customModelWrap.style.display = modelSelect.value === '__custom' ? '' : 'none';
    });

    selectPlan('basic');

    // Theme bootstrap
    (function initTheme() {
      const stored = localStorage.getItem('iv-theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = stored || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme === 'dark' ? 'dark' : 'light');
      darkToggle.checked = theme === 'dark';
    })();

    darkToggle.addEventListener('change', () => {
      const theme = darkToggle.checked ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('iv-theme', theme);
    });

    async function api(path, opts) {
      const res = await fetch(path, { credentials: 'include', ...opts });
      if (res.status === 401) { location.href = '/login.html'; return {}; }
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    let currentSub = null;
    function updateSubscriptionUI(subscription) {
      if (!subscription) return;
      currentSub = subscription;
      const normalizedPlan = normalizePlan(subscription.plan);
      const summary = `${displayPlan(normalizedPlan)} • ${titleCase((subscription.status || 'inactive').replace(/[._-]+/g, ' '))}`;
      subscriptionSummary.textContent = subscription.renewsAt
        ? `${summary} • Renews ${fmtDate(subscription.renewsAt)}`
        : summary;
      selectPlan(normalizedPlan || 'basic');
      planStatusMessage.textContent = '';

      const activeStatuses = new Set(['active','trialing','scheduled_for_cancellation']);
      const paidPlans = new Set(['basic','pro']);
      const showPrefs = paidPlans.has(normalizePlan(subscription.plan)) && activeStatuses.has((subscription.status || '').toLowerCase());
      prefsSection.style.display = showPrefs ? '' : 'none';
    }

    async function bootstrap() {
      const meResp = await api('/api/me');
      const me = meResp.user || {};
      document.getElementById('userEmail').textContent = me.email || '—';

      const subscriptionResp = await api('/billing/subscription');
      const sub = subscriptionResp.subscription || {};
      updateSubscriptionUI(sub);

      const activeStatuses = new Set(['active','trialing','scheduled_for_cancellation']);
      const paidPlans = new Set(['basic','pro']);
      const showPrefs = paidPlans.has(normalizePlan(sub.plan)) && activeStatuses.has((sub.status || '').toLowerCase());
      if (showPrefs) {
        const settingsResp = await api('/api/settings');
        const settings = settingsResp.settings || {};
        preferencesForm.openaiKey.value = settings.openaiKey || '';
        preferencesForm.omittedSenders.value = settings.omittedSenders || '';
        preferencesForm.importantDesc.value = settings.importantDesc || '';
        preferencesForm.gmailQuery.value = settings.gmailQuery || 'label:inbox';
        preferencesForm.gmailMaxResults.value = settings.gmailMaxResults ?? 200;
        preferencesForm.safeMode.checked = settings.safeMode ?? true;
        preferencesForm.allowAttachments.checked = settings.allowAttachments ?? true;
        preferencesForm.maxAttachmentMB.value = settings.maxAttachmentMB ?? 5;
        preferencesForm.maxImages.value = settings.maxImages ?? 3;
        preferencesForm.maxPdfTextChars.value = settings.maxPdfTextChars ?? 4000;
        const known = new Set(['', 'gpt-4.1-mini', 'gpt-4.1', 'gpt-5', 'o3-mini', 'o3', 'gpt-4o-mini', 'gpt-4o']);
        const model = (settings.model || '').trim();
        if (known.has(model)) {
          modelSelect.value = model;
          customModelWrap.style.display = 'none';
          preferencesForm.customModel.value = '';
        } else if (model) {
          modelSelect.value = '__custom';
          customModelWrap.style.display = '';
          preferencesForm.customModel.value = model;
        } else {
          modelSelect.value = '';
          customModelWrap.style.display = 'none';
          preferencesForm.customModel.value = '';
        }
      }
    }

    planForm.addEventListener('change', (event) => {
      if (event.target.name === 'plan') {
        selectPlan(event.target.value);
      }
    });

    planForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(planForm);
      const plan = formData.get('plan') || 'basic';
      planStatusMessage.textContent = 'Saving…';
      try {
        const activeStatuses = new Set(['active','trialing','scheduled_for_cancellation']);
        const paidPlans = new Set(['basic','pro']);
        const curPlan = normalizePlan(currentSub?.plan);
        const curActive = activeStatuses.has((currentSub?.status || '').toLowerCase());
        const wantsPaid = paidPlans.has(plan.toLowerCase());
        if (wantsPaid) {
          if (curActive && currentSub?.stripeSubscriptionId) {
            planStatusMessage.textContent = 'Opening billing portal to switch plan…';
            const portal = await api('/billing/portal', { method: 'POST' });
            if (portal?.url) { location.href = portal.url; return; }
            throw new Error('Unable to open billing portal');
          } else {
            planStatusMessage.textContent = 'Starting checkout…';
            const co = await api('/billing/checkout', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ plan }),
            });
            if (co?.url) { location.href = co.url; return; }
            throw new Error('Unable to start checkout');
          }
        } else {
          // Non-paid plan; just update our local store
          const resp = await api('/billing/subscription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan }),
          });
          updateSubscriptionUI(resp.subscription);
          planStatusMessage.textContent = 'Plan updated ✓';
          setTimeout(() => (planStatusMessage.textContent = ''), 2000);
        }
      } catch (err) {
        console.error(err);
        planStatusMessage.textContent = err.message;
      }
    });

    preferencesForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      preferencesStatus.textContent = 'Saving…';
      const modelValue = modelSelect.value === '__custom'
        ? preferencesForm.customModel.value.trim()
        : modelSelect.value;
      const payload = {
        openaiKey: preferencesForm.openaiKey.value.trim(),
        omittedSenders: preferencesForm.omittedSenders.value.trim(),
        importantDesc: preferencesForm.importantDesc.value.trim(),
        gmailQuery: preferencesForm.gmailQuery.value.trim() || 'label:inbox',
        gmailMaxResults: Math.max(1, Math.min(500, Number(preferencesForm.gmailMaxResults.value || 200))),
        safeMode: !!preferencesForm.safeMode.checked,
        allowAttachments: !!preferencesForm.allowAttachments.checked,
        maxAttachmentMB: Number(preferencesForm.maxAttachmentMB.value || 5),
        maxImages: Number(preferencesForm.maxImages.value || 3),
        maxPdfTextChars: Number(preferencesForm.maxPdfTextChars.value || 4000),
        model: modelValue,
      };
      try {
        await api('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        preferencesStatus.textContent = 'Preferences saved ✓';
        setTimeout(() => (preferencesStatus.textContent = ''), 2000);
      } catch (err) {
        console.error(err);
        preferencesStatus.textContent = err.message;
      }
    });

    // Manage billing (Stripe Customer Portal)
    document.getElementById('manageBillingBtn').addEventListener('click', async () => {
      planStatusMessage.textContent = 'Opening billing portal…';
      try {
        const res = await api('/billing/portal', { method: 'POST' });
        if (res && res.url) {
          location.href = res.url;
        } else {
          throw new Error('Failed to create portal session');
        }
      } catch (err) {
        console.error(err);
        planStatusMessage.textContent = err.message;
        setTimeout(() => (planStatusMessage.textContent = ''), 4000);
      }
    });

    // Cancel subscription (at period end)
    document.getElementById('cancelPlanBtn').addEventListener('click', async () => {
      if (!confirm('Cancel your subscription at period end?')) return;
      planStatusMessage.textContent = 'Submitting cancel…';
      try {
        const res = await api('/billing/cancel', { method: 'POST' });
        updateSubscriptionUI(res.subscription);
        planStatusMessage.textContent = 'Cancellation scheduled ✓';
        setTimeout(() => (planStatusMessage.textContent = ''), 4000);
      } catch (err) {
        console.error(err);
        planStatusMessage.textContent = err.message;
      }
    });

    bootstrap().catch((err) => {
      console.error(err);
      alert('Failed to load settings: ' + err.message);
    });
  </script>
</body>
</html>
