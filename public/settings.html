<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      color-scheme: light;
    }
    body[data-theme="dark"] {
      color-scheme: dark;
      background-color: #0f172a;
      color: #e2e8f0;
    }
    body[data-theme="dark"] header {
      background-color: #1e293b !important;
      border-color: #334155 !important;
    }
    body[data-theme="dark"] section {
      background-color: #1e293b !important;
      border-color: #334155 !important;
    }
    body[data-theme="dark"] .bg-white {
      background-color: #1e293b !important;
    }
    body[data-theme="dark"] .border-slate-200 {
      border-color: #334155 !important;
    }
    body[data-theme="dark"] .border-slate-300 {
      border-color: #475569 !important;
    }
    body[data-theme="dark"] .text-slate-900,
    body[data-theme="dark"] .text-slate-800,
    body[data-theme="dark"] .text-slate-700,
    body[data-theme="dark"] .text-slate-600 {
      color: #e2e8f0 !important;
    }
    body[data-theme="dark"] .text-slate-500 {
      color: #94a3b8 !important;
    }
    body[data-theme="dark"] a {
      color: #a5b4fc;
    }
    body[data-theme="dark"] input,
    body[data-theme="dark"] select,
    body[data-theme="dark"] textarea {
      background-color: #0f172a !important;
      color: #e2e8f0 !important;
      border-color: #475569 !important;
    }
    body[data-theme="dark"] input::placeholder,
    body[data-theme="dark"] textarea::placeholder {
      color: #64748b !important;
    }
    body[data-theme="dark"] .plan-card {
      background-color: #1e293b !important;
      border-color: #475569 !important;
    }
    body[data-theme="dark"] .plan-card[data-active="true"] {
      border-color: #818cf8 !important;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.35);
    }
    body[data-theme="dark"] .hover\:bg-slate-100:hover {
      background-color: #1e293b !important;
    }
  </style>
</head>
<body data-theme="light" class="bg-slate-50 text-slate-900">
  <header class="w-full bg-white border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-xl bg-indigo-600"></div>
        <div>
          <h1 class="text-xl font-semibold">Settings</h1>
          <p class="text-xs text-slate-500" id="userEmail">—</p>
        </div>
      </div>
      <a href="/dashboard.html" class="text-sm px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">Back to dashboard</a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6 space-y-6">
    <section id="subscription" class="bg-white border border-slate-200 rounded-xl p-6 space-y-4">
      <div class="flex flex-col gap-1">
        <h2 class="text-lg font-semibold">Subscription</h2>
        <p class="text-sm text-slate-500" id="subscriptionSummary">Loading…</p>
      </div>
      <form id="planForm" class="space-y-4">
        <fieldset class="grid gap-3 md:grid-cols-2">
          <label class="plan-card border border-slate-200 rounded-xl p-4 cursor-pointer hover:border-indigo-400 transition" data-plan-card data-plan="basic">
            <div class="flex items-start justify-between gap-3">
              <div>
                <span class="font-semibold text-base">Basic</span>
                <p class="text-xs text-slate-500 mt-1">Automated vetting with managed AI access.</p>
              </div>
              <input type="radio" name="plan" value="basic" class="h-4 w-4 text-indigo-600 border-slate-300">
            </div>
            <p class="mt-4 text-sm font-medium">$4.99<span class="text-xs text-slate-500">/mo</span></p>
            <p class="mt-2 text-xs text-slate-500">Includes the InboxVetter OpenAI key.</p>
          </label>
          <label class="plan-card border border-slate-200 rounded-xl p-4 cursor-pointer hover:border-indigo-400 transition" data-plan-card data-plan="test">
            <div class="flex items-start justify-between gap-3">
              <div>
                <span class="font-semibold text-base">Test plan</span>
                <p class="text-xs text-slate-500 mt-1">For staging environments and internal QA.</p>
              </div>
              <input type="radio" name="plan" value="test" class="h-4 w-4 text-indigo-600 border-slate-300">
            </div>
            <p class="mt-4 text-sm font-medium">Test mode</p>
            <p class="mt-2 text-xs text-slate-500">Uses the InboxVetter OpenAI key.</p>
          </label>
        </fieldset>
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <button type="submit" class="inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500 text-sm">Update plan</button>
          <span id="planStatusMessage" class="text-sm text-slate-500"></span>
        </div>
      </form>
    </section>

    <section class="bg-white border border-slate-200 rounded-xl p-6 space-y-5">
      <div>
        <h2 class="text-lg font-semibold">Preferences</h2>
        <p class="text-sm text-slate-500">These settings are stored server-side so you can pick up where you left off from any device.</p>
      </div>
      <form id="preferencesForm" class="space-y-5">
        <div class="grid gap-4 md:grid-cols-2">
          <label class="block" data-openai-field>
            <span class="text-sm font-medium text-slate-600">OpenAI API key</span>
            <input type="password" name="openaiKey" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" placeholder="sk-...">
            <span id="openaiKeyHint" class="block mt-1 text-xs text-slate-500">Used for outbound vetting. Stored encrypted in the local JSON store.</span>
            <span id="houseKeyNotice" class="block mt-1 text-xs text-indigo-500" style="display:none">InboxVetter manages your OpenAI access on this plan.</span>
          </label>
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Theme</span>
            <select name="theme" id="themeSelect" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
            <span class="block mt-1 text-xs text-slate-500">Switch between light and dark mode.</span>
          </label>
        </div>

        <label class="block">
          <span class="text-sm font-medium text-slate-600">Omitted senders (comma separated)</span>
          <input type="text" name="omittedSenders" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" placeholder="streamelements.com, noreply@paypal.com">
        </label>

        <label class="block">
          <span class="text-sm font-medium text-slate-600">What's important to you?</span>
          <textarea name="importantDesc" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" rows="4" placeholder="Sponsors, payments, security, school admin"></textarea>
        </label>

        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Allow attachments</span>
            <input type="checkbox" name="allowAttachments" class="mt-2 h-4 w-4 text-indigo-600 border-slate-300">
          </label>
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Max attachment size (MB)</span>
            <input type="number" name="maxAttachmentMB" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" min="1" step="1">
          </label>
        </div>

        <div class="grid gap-4 md:grid-cols-3">
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Max images per message</span>
            <input type="number" name="maxImages" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" min="0" step="1">
          </label>
          <label class="block md:col-span-2">
            <span class="text-sm font-medium text-slate-600">Max PDF text characters</span>
            <input type="number" name="maxPdfTextChars" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" min="500" step="100">
          </label>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <span class="text-sm font-medium text-slate-600">Default model</span>
            <select name="modelSelect" id="modelSelect" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2">
              <option value="">Use app default</option>
              <option value="gpt-4.1-mini">gpt-4.1-mini (recommended)</option>
              <option value="gpt-4.1">gpt-4.1</option>
              <option value="gpt-5">gpt-5 (reasoning)</option>
              <option value="o3-mini">o3-mini (reasoning, budget)</option>
              <option value="o3">o3</option>
              <option value="gpt-4o-mini">gpt-4o-mini (vision)</option>
              <option value="gpt-4o">gpt-4o</option>
              <option value="__custom">Custom…</option>
            </select>
          </label>
          <label class="block" id="customModelWrap" style="display:none">
            <span class="text-sm font-medium text-slate-600">Custom model ID</span>
            <input type="text" name="customModel" class="mt-1 w-full border border-slate-300 rounded-lg px-3 py-2" placeholder="text-your-model">
          </label>
        </div>

        <div class="flex items-center justify-between gap-3">
          <button type="submit" class="inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500 text-sm">Save preferences</button>
          <span id="preferencesStatus" class="text-sm text-slate-500"></span>
        </div>
      </form>
    </section>
  </main>

  <script>
    const planForm = document.getElementById('planForm');
    const planCards = Array.from(document.querySelectorAll('[data-plan-card]'));
    const planStatusMessage = document.getElementById('planStatusMessage');
    const subscriptionSummary = document.getElementById('subscriptionSummary');
    const preferencesForm = document.getElementById('preferencesForm');
    const preferencesStatus = document.getElementById('preferencesStatus');
    const modelSelect = document.getElementById('modelSelect');
    const customModelWrap = document.getElementById('customModelWrap');
    const themeSelect = document.getElementById('themeSelect');
    const openaiInput = preferencesForm.openaiKey;
    const openaiKeyHint = document.getElementById('openaiKeyHint');
    const houseKeyNotice = document.getElementById('houseKeyNotice');

    const planLabels = { basic: 'Basic', test: 'Test plan' };
    const planPricing = { basic: '$4.99/mo', test: 'Test mode' };
    const HOUSE_KEY_PLANS = new Set(['basic', 'test']);

    let storedOpenaiKey = '';
    let currentSubscription = null;

    const titleCase = (s) => s.replace(/\b([a-z])/g, (m) => m.toUpperCase());
    const normalizePlan = (slug) => (slug || '').toLowerCase();
    const planName = (slug) => planLabels[normalizePlan(slug)] || titleCase(normalizePlan(slug).replace(/[._-]+/g, ' ')) || 'Basic';
    const usesHousePlan = (plan) => HOUSE_KEY_PLANS.has(normalizePlan(plan));
    const fmtDate = (iso) => {
      if (!iso) return '—';
      try { return new Date(iso).toLocaleString(); } catch { return iso; }
    };

    function applyTheme(theme) {
      const desired = (theme || '').toLowerCase();
      const next = desired === 'dark' ? 'dark' : 'light';
      document.body.dataset.theme = next;
      if (themeSelect.value !== next) {
        themeSelect.value = next;
      }
    }

    function applyPlanEffects(plan, { managedOverride, preserveInput } = {}) {
      const normalized = normalizePlan(plan);
      const managed = managedOverride ?? usesHousePlan(normalized);
      if (managed) {
        if (!openaiInput.disabled && openaiInput.value) {
          storedOpenaiKey = openaiInput.value;
        }
        openaiInput.disabled = true;
        openaiInput.value = '';
        openaiInput.placeholder = 'Managed by InboxVetter';
        openaiKeyHint.style.display = 'none';
        houseKeyNotice.style.display = '';
      } else {
        openaiInput.disabled = false;
        openaiInput.placeholder = 'sk-...';
        openaiKeyHint.style.display = '';
        houseKeyNotice.style.display = 'none';
        if (!preserveInput) {
          openaiInput.value = storedOpenaiKey || '';
        }
      }
      openaiInput.dataset.managed = managed ? 'true' : 'false';
      return managed;
    }

    function selectPlan(plan) {
      const normalized = normalizePlan(plan);
      planCards.forEach((card) => {
        const cardPlan = normalizePlan(card.dataset.plan || card.querySelector('input[type="radio"]').value);
        const active = cardPlan === normalized;
        const input = card.querySelector('input[type="radio"]');
        if (input) input.checked = active;
        card.dataset.active = active ? 'true' : 'false';
        card.classList.toggle('border-indigo-500', active);
        card.classList.toggle('shadow-sm', active);
      });
    }

    function handleModelSelectChange() {
      customModelWrap.style.display = modelSelect.value === '__custom' ? '' : 'none';
    }

    modelSelect.addEventListener('change', handleModelSelectChange);
    themeSelect.addEventListener('change', () => applyTheme(themeSelect.value));

    selectPlan('basic');
    applyPlanEffects('basic', { preserveInput: true });

    async function api(path, opts) {
      const res = await fetch(path, { credentials: 'include', ...opts });
      if (res.status === 401) { location.href = '/login.html'; return {}; }
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function updateSubscriptionUI(subscription) {
      if (!subscription) return;
      currentSubscription = subscription;
      const plan = normalizePlan(subscription.plan || 'basic');
      selectPlan(plan);
      const managed = applyPlanEffects(plan, { managedOverride: subscription.usesHouseOpenAIKey, preserveInput: true });
      const statusText = titleCase((subscription.status || 'inactive').replace(/[._-]+/g, ' '));
      const details = [planName(plan), statusText];
      if (planPricing[plan]) details.push(planPricing[plan]);
      if (managed) details.push('InboxVetter key');
      if (subscription.renewsAt) details.push(`Renews ${fmtDate(subscription.renewsAt)}`);
      subscriptionSummary.textContent = details.join(' • ');
      planStatusMessage.textContent = '';
    }

    async function bootstrap() {
      const meResp = await api('/api/me');
      const me = meResp.user || {};
      document.getElementById('userEmail').textContent = me.email || '—';

      const settingsResp = await api('/api/settings');
      const settings = settingsResp.settings || {};
      storedOpenaiKey = settings.openaiKey || '';
      preferencesForm.omittedSenders.value = settings.omittedSenders || '';
      preferencesForm.importantDesc.value = settings.importantDesc || '';
      preferencesForm.allowAttachments.checked = settings.allowAttachments ?? true;
      preferencesForm.maxAttachmentMB.value = settings.maxAttachmentMB ?? 5;
      preferencesForm.maxImages.value = settings.maxImages ?? 3;
      preferencesForm.maxPdfTextChars.value = settings.maxPdfTextChars ?? 4000;

      const knownModels = new Set(['', 'gpt-4.1-mini', 'gpt-4.1', 'gpt-5', 'o3-mini', 'o3', 'gpt-4o-mini', 'gpt-4o']);
      const model = (settings.model || '').trim();
      if (knownModels.has(model)) {
        modelSelect.value = model;
        customModelWrap.style.display = 'none';
        preferencesForm.customModel.value = '';
      } else if (model) {
        modelSelect.value = '__custom';
        customModelWrap.style.display = '';
        preferencesForm.customModel.value = model;
      } else {
        modelSelect.value = '';
        customModelWrap.style.display = 'none';
        preferencesForm.customModel.value = '';
      }

      const usingHouseKey = Boolean(settings.usingHouseOpenAIKey);
      if (!usingHouseKey) {
        openaiInput.value = storedOpenaiKey;
      }
      applyPlanEffects('basic', { managedOverride: usingHouseKey, preserveInput: true });
      const theme = settings.theme || 'light';
      themeSelect.value = theme;
      applyTheme(theme);

      const subscriptionResp = await api('/billing/subscription');
      updateSubscriptionUI(subscriptionResp.subscription);
    }

    planForm.addEventListener('change', (event) => {
      if (event.target.name === 'plan') {
        const selectedPlan = event.target.value;
        selectPlan(selectedPlan);
        applyPlanEffects(selectedPlan);
      }
    });

    planForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(planForm);
      const plan = formData.get('plan') || 'basic';
      planStatusMessage.textContent = 'Saving…';
      try {
        const resp = await api('/billing/subscription', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ plan }),
        });
        updateSubscriptionUI(resp.subscription);
        planStatusMessage.textContent = 'Plan updated ✓';
        setTimeout(() => (planStatusMessage.textContent = ''), 2000);
      } catch (err) {
        console.error(err);
        planStatusMessage.textContent = err.message;
      }
    });

    preferencesForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      preferencesStatus.textContent = 'Saving…';
      const modelValue = modelSelect.value === '__custom'
        ? preferencesForm.customModel.value.trim()
        : modelSelect.value;
      const payload = {
        omittedSenders: preferencesForm.omittedSenders.value.trim(),
        importantDesc: preferencesForm.importantDesc.value.trim(),
        allowAttachments: !!preferencesForm.allowAttachments.checked,
        maxAttachmentMB: Number(preferencesForm.maxAttachmentMB.value || 5),
        maxImages: Number(preferencesForm.maxImages.value || 3),
        maxPdfTextChars: Number(preferencesForm.maxPdfTextChars.value || 4000),
        model: modelValue,
        theme: themeSelect.value,
      };
      if (!openaiInput.disabled) {
        payload.openaiKey = openaiInput.value.trim();
      }
      try {
        const resp = await api('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const saved = resp.settings || {};
        if (!openaiInput.disabled) {
          storedOpenaiKey = openaiInput.value.trim();
        }
        applyTheme(saved.theme || themeSelect.value);
        if (typeof saved.usingHouseOpenAIKey === 'boolean') {
          applyPlanEffects(currentSubscription?.plan || 'basic', {
            managedOverride: saved.usingHouseOpenAIKey,
            preserveInput: true,
          });
        }
        preferencesStatus.textContent = 'Preferences saved ✓';
        setTimeout(() => (preferencesStatus.textContent = ''), 2000);
      } catch (err) {
        console.error(err);
        preferencesStatus.textContent = err.message;
      }
    });

    bootstrap().catch((err) => {
      console.error(err);
      alert('Failed to load settings: ' + err.message);
    });
  </script>
</body>
</html>
