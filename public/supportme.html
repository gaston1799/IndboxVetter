<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Support InboxVetter</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="w-full bg-white border-b border-slate-200">
    <div class="max-w-3xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-xl bg-indigo-600"></div>
        <div>
          <h1 class="text-xl font-semibold">InboxVetter</h1>
          <p class="text-xs text-slate-500">Support the project</p>
        </div>
      </div>
      <a href="/dashboard.html" class="text-sm px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">Back to dashboard</a>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-10">
    <section class="bg-white border border-slate-200 rounded-xl p-6 space-y-6">
      <div>
        <h2 class="text-2xl font-semibold">Buy us a coffee ☕</h2>
        <p class="mt-2 text-sm text-slate-600">
          InboxVetter stays alive thanks to people like you. Choose any amount below and you'll be redirected to Stripe to complete the donation.
        </p>
        <p id="supportEmailWrap" class="mt-2 text-xs text-slate-500 hidden">
          Your donation will be associated with <span id="supportEmail" class="font-medium"></span>.
        </p>
      </div>

      <form id="supportForm" class="space-y-4">
        <div>
          <label for="amount" class="block text-sm font-medium text-slate-700">Donation amount (USD)</label>
          <div class="mt-1 relative rounded-lg shadow-sm">
            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">$</div>
            <input
              type="number"
              id="amount"
              name="amount"
              min="1"
              step="0.01"
              required
              inputmode="decimal"
              placeholder="10.00"
              class="block w-full rounded-lg border border-slate-300 pl-7 pr-3 py-2 focus:border-indigo-500 focus:ring-indigo-500 text-sm"
            />
          </div>
          <p class="mt-1 text-xs text-slate-500">Minimum donation is $1.00.</p>
        </div>

        <button
          type="submit"
          id="supportSubmit"
          class="w-full sm:w-auto inline-flex justify-center text-sm font-medium px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >Donate with Stripe</button>

        <div id="message" class="hidden mt-4 text-sm rounded-lg border px-4 py-3"></div>
      </form>
    </section>
  </main>

  <script>
    const messageEl = document.getElementById('message');
    const messageBaseClass = 'mt-4 text-sm rounded-lg border px-4 py-3';
    const messageVariants = {
      success: 'border-green-200 bg-green-50 text-green-700',
      error: 'border-red-200 bg-red-50 text-red-700',
      info: 'border-blue-200 bg-blue-50 text-blue-700'
    };

    function showMessage(type, text) {
      const variant = messageVariants[type] || messageVariants.info;
      messageEl.className = `${messageBaseClass} ${variant}`;
      messageEl.textContent = text;
    }

    function hideMessage() {
      messageEl.className = `${messageBaseClass} hidden`;
      messageEl.textContent = '';
    }

    const params = new URLSearchParams(window.location.search);
    if (params.get('success')) {
      showMessage('success', 'Thank you! Your donation was received successfully.');
      window.history.replaceState({}, document.title, window.location.pathname);
    } else if (params.get('canceled')) {
      showMessage('error', 'Donation canceled. Feel free to try again whenever you are ready.');
      window.history.replaceState({}, document.title, window.location.pathname);
    } else {
      hideMessage();
    }

    async function fetchProfile() {
      try {
        const res = await fetch('/api/me', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        const email = data?.user?.email;
        if (email) {
          const wrap = document.getElementById('supportEmailWrap');
          const emailEl = document.getElementById('supportEmail');
          emailEl.textContent = email;
          wrap.classList.remove('hidden');
        }
      } catch (err) {
        console.warn('Failed to load profile for donation page:', err);
      }
    }

    fetchProfile();

    const form = document.getElementById('supportForm');
    const amountInput = document.getElementById('amount');
    const submitBtn = document.getElementById('supportSubmit');
    const defaultBtnText = submitBtn.textContent;

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const raw = amountInput.value.trim();
      const amount = Number.parseFloat(raw);

      if (!Number.isFinite(amount) || amount < 1) {
        showMessage('error', 'Please enter a valid amount of at least $1.00.');
        return;
      }

      hideMessage();
      submitBtn.disabled = true;
      submitBtn.textContent = 'Redirecting…';

      let redirecting = false;

      try {
        const response = await fetch('/billing/support', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ amount })
        });

        const payload = await response.json().catch(() => ({}));

        if (!response.ok || !payload?.ok || !payload?.url) {
          const message = payload?.error || 'Unable to start the Stripe checkout session.';
          throw new Error(message);
        }

        redirecting = true;
        window.location.href = payload.url;
      } catch (err) {
        showMessage('error', err.message || 'Unexpected error. Please try again.');
      } finally {
        if (!redirecting) {
          submitBtn.disabled = false;
          submitBtn.textContent = defaultBtnText;
        }
      }
    });
  </script>
</body>
</html>
